<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥ä¿ç”³æŠ¥èµ„æ–™åˆå¹¶å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; }
        h1 { text-align: center; }
        
        /* Tab styling */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #007bff; }
        .tab { padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: #007bff; color: white; border-color: #007bff; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ddd; border-top: none; }
        .tab-content.active { display: block; }
        
        /* Form styling */
        form { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        input[type="file"] { border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        
        /* Status and stats styling */
        #status { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            border-left: 4px solid #007bff;
            text-align: left; 
            line-height: 1.6;
        }
        #status strong { color: #2c3e50; }
        #status.success { border-left-color: #28a745; background-color: #d4edda; }
        #status.error { border-left-color: #dc3545; background-color: #f8d7da; }
        
        /* Data viewer styling */
        .stats { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .table-container { margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ğŸ¥ è¯Šæ‰€æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('upload')">æ–‡ä»¶ä¸Šä¼ ä¸åˆå¹¶</div>
        <div class="tab" onclick="switchTab('multiFormat')">å¤šæ ¼å¼å¤„ç†</div>
        <div class="tab" onclick="switchTab('viewer')">æ•°æ®æŸ¥çœ‹å™¨</div>
    </div>
    
    <div id="uploadTab" class="tab-content active">
        <form id="uploadForm">
            <label for="zipFiles">è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ ZIP æ¡£æ¡ˆ (å¯å¤šé€‰):</label>
            <input type="file" id="zipFiles" name="zipFiles" multiple accept=".zip">
            <button type="submit">å¼€å§‹åˆå¹¶ä¸ä¸‹è½½</button>
        </form>
        <div id="status">è¯·é€‰æ‹©æ¡£æ¡ˆ...</div>
    </div>
    
    <div id="multiFormatTab" class="tab-content">
        <h2>ğŸ“ å¤šæ ¼å¼æª”æ¡ˆè™•ç†</h2>
        <p>æ”¯æ´å°ç£å¸¸è¦‹HISç³»çµ±æ ¼å¼ï¼šDBFã€Accessã€CSVã€å›ºå®šå¯¬åº¦TXTã€XML</p>
        
        <form id="multiFormatForm">
            <label for="multiFiles">è«‹é¸æ“‡è¦è™•ç†çš„æª”æ¡ˆ (å¯å¤šé¸):</label>
            <input type="file" id="multiFiles" name="multiFiles" multiple accept=".dbf,.mdb,.accdb,.csv,.txt,.xml">
            <button type="submit">é–‹å§‹è™•ç†èˆ‡å°å…¥</button>
        </form>
        
        <div id="multiFormatStatus" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
            è«‹é¸æ“‡æª”æ¡ˆ...
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background-color: #e8f5e8; border-radius: 8px;">
            <h3>ğŸ“‹ æ”¯æ´æ ¼å¼èªªæ˜</h3>
            <ul>
                <li><strong>DBF</strong> - å±•æœ›ã€é†«è–ã€è€€è–ç³»çµ±</li>
                <li><strong>Access</strong> - MDB/ACCDB è³‡æ–™åº«æ–‡ä»¶</li>
                <li><strong>CSV</strong> - å ±è¡¨åŒ¯å‡ºæ ¼å¼</li>
                <li><strong>å›ºå®šå¯¬åº¦TXT</strong> - æ—©æœŸå¥ä¿ç”³å ±æ ¼å¼</li>
                <li><strong>XML</strong> - å¥åº·ä¿éšªäº¤æ›æ ¼å¼</li>
            </ul>
        </div>
    </div>
    
    <div id="viewerTab" class="tab-content">
        <div class="stats">
            <h2>ğŸ“Š èµ„æ–™ç»Ÿè®¡</h2>
            <p>â€¢ ç—…æ‚£è®°å½•: <strong id="patientCount">è½½å…¥ä¸­...</strong> ç¬”</p>
            <p>â€¢ å°±è¯Šè®°å½•: <strong id="visitCount">è½½å…¥ä¸­...</strong> ç¬”</p>
            <p>â€¢ è¯Šæ–­è®°å½•: <strong id="diagnosisCount">è½½å…¥ä¸­...</strong> ç¬”</p>
            <p>â€¢ å¤„æ–¹è®°å½•: <strong id="prescriptionCount">è½½å…¥ä¸­...</strong> ç¬”</p>
            <button onclick="loadStats()">æ›´æ–°ç»Ÿè®¡èµ„æ–™</button>
        </div>

        <div class="table-container">
            <h2>ğŸ‘¥ ç—…æ‚£èµ„æ–™ (å‰10ç¬”)</h2>
            <button onclick="loadPatients()">è½½å…¥ç—…æ‚£èµ„æ–™</button>
            <div id="patientsTable"></div>
        </div>

        <div class="table-container">
            <h2>ğŸ“… å°±è¯Šè®°å½• (å‰10ç¬”)</h2>
            <button onclick="loadVisits()">è½½å…¥å°±è¯Šè®°å½•</button>
            <div id="visitsTable"></div>
        </div>

        <div class="table-container">
            <h2>ğŸ¥ è¯Šæ–­è®°å½• (å‰10ç¬”)</h2>
            <button onclick="loadDiagnoses()">è½½å…¥è¯Šæ–­è®°å½•</button>
            <div id="diagnosesTable"></div>
        </div>

        <div class="table-container">
            <h2>ğŸ’Š å¤„æ–¹è®°å½• (å‰10ç¬”)</h2>
            <button onclick="loadPrescriptions()">è½½å…¥å¤„æ–¹è®°å½•</button>
            <div id="prescriptionsTable"></div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Auto-load stats when switching to viewer tab
            if (tabName === 'viewer') {
                loadStats();
            }
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                document.getElementById('patientCount').textContent = data.patientCount;
                document.getElementById('visitCount').textContent = data.visitCount;
                document.getElementById('diagnosisCount').textContent = data.diagnosisCount;
                document.getElementById('prescriptionCount').textContent = data.prescriptionCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadPatients() {
            try {
                const response = await fetch('/api/patients');
                const data = await response.json();
                displayTable('patientsTable', data, ['patient_id', 'id_card_number', 'name', 'birth_date', 'gender']);
            } catch (error) {
                document.getElementById('patientsTable').innerHTML = '<p style="color: red;">æ— æ³•è½½å…¥èµ„æ–™</p>';
            }
        }

        async function loadVisits() {
            try {
                const response = await fetch('/api/visits');
                const data = await response.json();
                displayTable('visitsTable', data, ['visit_id', 'patient_id', 'visit_date']);
            } catch (error) {
                document.getElementById('visitsTable').innerHTML = '<p style="color: red;">æ— æ³•è½½å…¥èµ„æ–™</p>';
            }
        }

        async function loadDiagnoses() {
            try {
                const response = await fetch('/api/diagnoses');
                const data = await response.json();
                displayTable('diagnosesTable', data, ['diagnosis_id', 'visit_id', 'icd10_code', 'diagnosis_description']);
            } catch (error) {
                document.getElementById('diagnosesTable').innerHTML = '<p style="color: red;">æ— æ³•è½½å…¥èµ„æ–™</p>';
            }
        }

        async function loadPrescriptions() {
            try {
                const response = await fetch('/api/prescriptions');
                const data = await response.json();
                displayTable('prescriptionsTable', data, ['prescription_id', 'visit_id', 'medication_name', 'dosage', 'frequency', 'days', 'total_quantity']);
            } catch (error) {
                document.getElementById('prescriptionsTable').innerHTML = '<p style="color: red;">æ— æ³•è½½å…¥èµ„æ–™</p>';
            }
        }

        function displayTable(containerId, data, columns) {
            if (!data || data.length === 0) {
                document.getElementById(containerId).innerHTML = '<p>æ²¡æœ‰èµ„æ–™</p>';
                return;
            }

            let html = '<table><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr>';

            data.slice(0, 10).forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            
            document.getElementById(containerId).innerHTML = html;
        }
    </script>
</body>
</html>
