# 业务日志：健保申报资料多档案合并网页

**日期：** 2025-08-28

## 一、专案目标

将现有的单档案ETL指令码工具，升级为一套提供给诊所人员使用的Web网页服务。此服务旨在解决诊所每月需合并多个申报档案的痛点，简化作业流程，并提供标准化的合并后档案。

## 二、核心功能

1.  **多档上传**：使用者能透过网页介面，一次选择并上传多个ZIP压缩档。
2.  **自动合并**：后端服务能自动解压缩所有ZIP档，读取其中的XML申报资料，并将所有就诊纪录 (`<ddata>`) 合并至一个主要的XML档案中。
3.  **结果回传**：服务在处理完毕后，需提供合并后的XML档案供使用者下载。
4.  **伺服器存档**：合并后的档案也需在伺服器上存档，以供后续稽核或使用。

## 三、技术架构规划

-   **后端 (Backend)**: Node.js + Express.js
-   **前端 (Frontend)**: HTML + CSS + JavaScript
-   **档案处理**: `multer` (处理上传), `adm-zip` (解压缩)

## 四、专案结构规划

```
clinic-data-etl/
│── server.js               # Web服务器主程式
│── package.json
│── public/                 # 存放前端网页文件
│    ├── index.html
│    └── script.js
│── uploads/                # 暂时存放上传的ZIP档
│── merged/                 # 存放合并后的XML成品
│── src/                    # 现有ETL核心逻辑
│    ├── ...
```

## 五、开发步骤

1.  **环境建置**：安装 `express`, `multer`, `adm-zip`, `cors` 等新的NPM函式库。
2.  **结构建立**：创建 `public`, `uploads`, `merged` 等新目录及 `server.js` 等新档案。
3.  **后端开发**：
    *   使用 Express 建立基础Web服务与静态文件托管。
    *   建立 `/api/merge-files` API 端点，并使用 Multer 配置档案上传功能。
    *   编写核心业务逻辑：处理档案的解压缩、读取、合并、储存与回传。
4.  **前端开发**：
    *   建立 `index.html` 上传介面。
    *   编写 `script.js`，透过 `fetch` API 与后端进行通讯，并处理档案下载。
5.  **整合测试与侦错**：
    *   解决了前端 `Failed to fetch` 的 CORS 跨来源安全性问题。
    *   修正了前端 JavaScript 无法触发下载的浏览器时序性问题。

## 六、最终成果 (2025-08-28)

**状态：** **功能开发完成，测试成功！**

专案已成功从一个指令码工具，升级为一个功能完整的Web应用。使用者可以透过浏览器上传多个ZIP档案，伺服器会自动完成合并，并将结果回传给使用者下载，同时在伺服器上存档。所有核心功能均已实现并通过测试。

---

## **第二阶段：通用资料转换器开发计划 (2025-08-28)**

### 一、目标

扩展现有网页应用，使其具备处理多种不同资料格式（如 DBF, CSV）的能力，并将其转换为统一的、标准化的 JSON 格式后回传给使用者。

### 二、第一阶段执行项目：DBF 格式转换器

为验证此概念，我们将首先实现对 DBF 格式的支援。

1.  **前端更新**：在 `index.html` 页面上新增“DBF 资料转换”功能区，包含独立的档案上传元件。
2.  **后端更新**：
    *   在 `server.js` 中建立新的 API 端点 `/api/convert-dbf`。
    *   此端点将使用 `dbfLoader.js` 来解析上传的 DBF 档案。
3.  **核心转换逻辑**：
    *   建立一个新的 `dbfTransformer.js` 模组。
    *   此模组的核心任务是将 DBF 的栏位对应到我们已定义的标准 JSON 结构上。

### 三、资料对应表 (DBF to JSON) - **模板**

**注意：** 此对应表为模板，需要等待使用者提供真实的 DBF 档案及其栏位说明后，才能进行填充和开发。

| 标准JSON栏位 (Standard JSON) | DBF 栏位 (示例) | 说明 (Description) |
| -------------------------- | ----------------- | ------------------ |
| `id_card_number`           | `PAT_IDNO`        | 病患身分证号       |
| `name`                     | `PAT_NAME`        | 病患姓名           |
| `birth_date`               | `PAT_BIR`         | 出生年月日         |
| `visit_date`               | `VIS_DATE`        | 就诊日期           |
| `medication_code`          | `DRUG_CODE`       | 药品代号           |
| `...`                      | `...`             | ...                |

### 四、下一步行动

1.  **等待使用者提供**：
    *   一份用于测试的 `.dbf` 档案。
    *   一份该档案的栏位说明文件。
2.  **完成后端开发**：根据栏位说明，完成 `dbfTransformer.js` 的开发。
3.  **完成前端开发**：完成新功能区的前端逻辑。
4.  **整合测试**。
